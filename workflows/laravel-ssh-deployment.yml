name: Hostinger Deploy

on:
  push:
    branches: ["production"]
  workflow_dispatch:

jobs:
  build-assets:
    name: Build Frontend Assets
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, bcmath, pdo_mysql, pdo_sqlite, gd, zip
          coverage: none

      - name: Create .env only if missing
        run: |
          if [ ! -f .env ]; then
            if [ -f .env.example ]; then
              cp .env.example .env
              echo "Created .env from .env.example"
            else
              echo "âš ï¸ .env.example not found, creating minimal .env"
              echo "APP_ENV=testing" > .env
              echo "APP_KEY=" >> .env
            fi
          else
            echo "â„¹ï¸ .env already exists, skipping creation"
          fi

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Generate Application Key
        run: php artisan key:generate --ansi

      - name: Check for package.json
        id: check_package
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check_package.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: Install NPM Dependencies
        if: steps.check_package.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "â„¹ï¸ No package-lock.json found, using npm install"
            npm install
          fi

      - name: Build Assets
        if: steps.check_package.outputs.exists == 'true'
        continue-on-error: true
        run: |
          if grep -q "\"build\"" package.json || grep -q "\"prod\"" package.json; then
            npm run build || npm run prod || echo "âš ï¸ Build script not found or failed"
          else
            echo "âš ï¸ No build script found in package.json"
          fi

      - name: Upload Built Assets
        if: steps.check_package.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: public/build/
          if-no-files-found: ignore
          retention-days: 1

  deploy:
    name: Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: [build-assets]
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, bcmath, pdo_mysql

      - name: Download Built Assets
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: public/build/
        continue-on-error: true

      - name: Setup Node.js (for asset building)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: Build Frontend Assets (if needed)
        continue-on-error: true
        if: hashFiles('package.json') != ''
        run: |
          echo "ðŸ“¦ Installing NPM dependencies..."
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit || npm install --prefer-offline --no-audit
          else
            echo "â„¹ï¸ No package-lock.json found, using npm install"
            npm install --prefer-offline --no-audit
          fi

          if grep -q "\"build\"" package.json || grep -q "\"prod\"" package.json; then
            echo "ðŸ”¨ Building assets for production..."
            npm run build || npm run prod || echo "âš ï¸ Build script not found or failed"
            echo "â„¹ï¸ Note: Built assets should be committed to your repository for deployment"
            echo "   (NPM may not be available on the remote server)"
          else
            echo "â„¹ï¸ No build script found in package.json"
          fi

      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync Build Assets to Server
        run: |
          # 1ï¸âƒ£ Ensure build directory exists
          ssh -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "mkdir -p ~/domains/${{ secrets.WEBSITE_FOLDER }}/public/build"

          # 2ï¸âƒ£ Sync (replace contents, remove stale files)
          if [ -d "${{ github.workspace }}/public/build" ]; then
            rsync -avz --delete \
              -e "ssh -p ${{ secrets.SSH_PORT }}" \
              ${{ github.workspace }}/public/build/ \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:~/domains/${{ secrets.WEBSITE_FOLDER }}/public/build/
          else
            echo "â„¹ï¸ No local build directory found, skipping asset sync"
          fi

      - name: Deploy to Hostinger Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "ðŸš€ Starting deployment..."

            cd domains/${{ secrets.WEBSITE_FOLDER }}



            if [ ! -d ".git" ]; then
              echo "ðŸ“Œ Git not found. Initializing repo..."

              git init
              git remote add origin git@github.com:sparklem-agency/repo.in.git

              echo "ðŸ“¥ Fetching branch production..."
              git fetch origin production --depth=1

              echo "ðŸ“‚ Checking out production..."
              git checkout -b production origin/production
            else
              echo "ðŸ”„ Git repo found. Pulling latest..."
              git pull origin production
            fi

            echo "ðŸ“¦ Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

            # Note: Frontend assets should already be built and committed
            # If you need to build on server, ensure npm/node is available
            # and uncomment the following lines:
            # if [ -f package.json ]; then
            #   npm ci --production && npm run build || npm run prod
            # fi

            # --- Ensure public_html points to public ---
            if [ ! -L public_html ] || [ "$(readlink public_html)" != "public" ]; then
              echo "ðŸ”— Creating symbolic link: public_html -> public"
              rm -rf public_html
              ln -s public public_html
            fi

            echo "ðŸ”§ Running Laravel setup commands..."

            # Run migrations
            php artisan migrate --force

            # Clear and cache configuration
            php artisan config:clear
            php artisan config:cache

            # Clear and cache routes
            php artisan route:clear
            php artisan route:cache

            # Clear and cache views
            php artisan view:clear
            php artisan view:cache

            # Optimize application
            php artisan optimize:clear
            php artisan optimize

            # Clear and cache events (if available)
            php artisan event:clear || true
            php artisan event:cache || true

            # Restart queue workers (if using queues)
            php artisan queue:restart || true

            # Restart Horizon (if using Laravel Horizon)
            php artisan horizon:terminate || true

            # Clear application cache
            php artisan cache:clear

            # Clear OPcache (if available)
            php artisan opcache:clear || true

            echo "âœ… Deployment completed successfully!"

            # Show deployment info
            echo ""
            echo "ðŸ“Š Deployment Information:"
            echo "   Branch: {{BRANCH}}"
            echo "   Commit: $(git rev-parse --short HEAD)"
            echo "   Date: $(date)"
